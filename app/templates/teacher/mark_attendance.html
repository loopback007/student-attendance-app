{% extends "base.html" %}

{% block title %}{{ title }} - {{ subject_class.name }}{% endblock %}

{% block head_extensions %}
<style>
    .content-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid #e9ecef;
    }
    .content-header h1 { margin-bottom: 5px; font-size: 1.75rem; }
    .content-header .text-muted { color: #6c757d !important; font-size: 0.9em; }
    .date-selector-form { margin-bottom: 20px; display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
    .date-selector-form label { margin-bottom: 0; font-weight: normal; }
    .form-control-sm { height: calc(1.5em + .5rem + 2px); padding: .25rem .5rem; font-size: .875rem; line-height: 1.5; border-radius: .2rem; }
    .btn-sm { padding: .25rem .5rem; font-size: .875rem; line-height: 1.5; border-radius: .2rem; }
    
    .attendance-table { width: 100%; margin-bottom: 1rem; color: #212529; border-collapse: collapse; }
    .attendance-table th, .attendance-table td { padding: 0.65rem; vertical-align: middle; border-top: 1px solid #dee2e6; }
    .attendance-table thead th { vertical-align: bottom; border-bottom: 2px solid #dee2e6; text-align: left; background-color: #f8f9fa; }
    .attendance-table tbody tr:nth-of-type(odd) { background-color: rgba(0,0,0,.03); }
    .attendance-table tbody tr:hover { background-color: rgba(0,0,0,.05); }

    .student-name-col { width: 30%; }
    .status-col { width: 25%; }
    .remarks-col { width: 45%; }

    .form-control, .custom-select {
        display: block; width: 100%; box-sizing: border-box; padding: 0.375rem 0.75rem;
        font-size: 0.9rem; line-height: 1.5; color: #495057; background-color: #fff;
        background-clip: padding-box; border: 1px solid #ced4da; border-radius: 0.25rem;
        transition: border-color .15s ease-in-out,box-shadow .15s ease-in-out;
    }
    .form-control:focus, .custom-select:focus {
        border-color: #80bdff; outline: 0; box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
    }
    .form-control.is-invalid, .custom-select.is-invalid { border-color: #dc3545; }
    .invalid-feedback { display: none; width: 100%; margin-top: 0.25rem; font-size: 0.875em; color: #dc3545; }
    .form-control.is-invalid ~ .invalid-feedback, .custom-select.is-invalid ~ .invalid-feedback { display: block; }

    .submit-button-container { margin-top: 20px; text-align: right; }
    .btn-primary { color: #fff; background-color: #007bff; border-color: #007bff; }
    .btn-primary:hover { background-color: #0056b3; }
    .btn-secondary { color: #fff; background-color: #6c757d; border-color: #6c757d; }
    .btn-secondary:hover { background-color: #545b62; }
    .btn-outline-secondary { color: #6c757d; border-color: #6c757d; background-color: transparent; }
    .btn-outline-secondary:hover { color: #fff; background-color: #6c757d; }
    .alert-info { color: #0c5460; background-color: #d1ecf1; border-color: #bee5eb; padding: .75rem 1.25rem; margin-bottom: 1rem; border-radius: .25rem; }
    .scheduled-day-info { font-size: 0.85em; color: #555; margin-left: 15px; }
    
    .arrears-indicator { /* Style for the arrears flag */
        display: inline-block;
        padding: .2em .4em;
        font-size: 70%;
        font-weight: 700;
        line-height: 1;
        color: #fff;
        text-align: center;
        white-space: nowrap;
        vertical-align: super; /* Aligns a bit higher */
        border-radius: .25rem;
        background-color: #dc3545; /* Red for arrears */
        margin-left: 5px;
        cursor: help; /* Indicate more info on hover, if you add a title attribute */
    }
</style>
{% endblock %}

{% block content %}
<div class="content-header">
    <div>
        <h1>{{ title }}</h1>
        <p class="text-muted">
            <strong>Subject:</strong> {{ subject_class.subject_taught.name if subject_class.subject_taught else 'N/A' }} |
            <strong>Date:</strong> {{ selected_date_for_display.strftime('%A, %B %d, %Y') }}
            {% if subject_class.schedule_details %}
                <span class="scheduled-day-info">(Class normally on: {{ subject_class.schedule_details[:3] }})</span>
            {% endif %}
        </p>
    </div>
    <a href="{{ url_for('teacher.my_classes') }}" class="btn btn-outline-secondary btn-sm">Back to My Classes</a>
</div>

{# Form to select a different date #}
<form method="GET" action="{{ url_for('teacher.mark_attendance', class_id=subject_class.id) }}" class="date-selector-form">
    <label for="attendance_date_picker">Change Date:</label>
    <input type="date" id="attendance_date_picker" name="attendance_date" 
           value="{{ selected_date_for_display.strftime('%Y-%m-%d') }}" class="form-control form-control-sm" style="width: auto;">
    <button type="submit" class="btn btn-secondary btn-sm">View Date</button>
    {% if scheduled_weekday_num is not none %}
        <small class="text-muted">Note: Attendance is typically recorded for {{ ["Mondays", "Tuesdays", "Wednesdays", "Thursdays", "Fridays", "Saturdays", "Sundays"][scheduled_weekday_num] }}.</small>
    {% endif %}
</form>

{% if enrolled_students_for_template %}
<form method="POST" action="{{ url_for('teacher.mark_attendance', class_id=subject_class.id) }}">
    {{ form.hidden_tag() }} {# Main form CSRF token #}
    {{ form.attendance_date() }} 

    <table class="attendance-table">
        <thead>
            <tr>
                <th class="student-name-col">Student Name</th>
                <th class="status-col">Status</th>
                <th class="remarks-col">Remarks</th>
            </tr>
        </thead>
        <tbody>
            {% for student_obj in enrolled_students_for_template %}
                {% set loop_idx = loop.index0 %} 
                {% set student_form_entry = form.students_attendance[loop_idx] %} 
                <tr>
                    <td>
                        {{ student_obj.first_name }} {{ student_obj.last_name }}
                        ({{ student_obj.student_id_number }})
                        {# ADDED ARREARS INDICATOR #}
                        {% if student_obj.is_in_arrears %}
                            <span class="arrears-indicator" title="Account in Arrears">!</span>
                        {% endif %}
                        {{ student_form_entry.student_id() }} 
                    </td>
                    <td>
                        {{ student_form_entry.status(class="form-control custom-select " + ("is-invalid" if student_form_entry.status.errors else "")) }}
                        {% if student_form_entry.status.errors %}
                            <div class="invalid-feedback">
                                {% for error in student_form_entry.status.errors %}<span>{{ error }}</span><br>{% endfor %}
                            </div>
                        {% endif %}
                    </td>
                    <td>
                        {{ student_form_entry.remarks(class="form-control " + ("is-invalid" if student_form_entry.remarks.errors else ""), placeholder="Optional remarks") }}
                        {% if student_form_entry.remarks.errors %}
                            <div class="invalid-feedback">
                                {% for error in student_form_entry.remarks.errors %}<span>{{ error }}</span><br>{% endfor %}
                            </div>
                        {% endif %}
                    </td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
    <div class="submit-button-container">
        {{ form.submit(class="btn btn-primary btn-lg") }}
    </div>
</form>
{% else %}
<div class="alert alert-info" role="alert">
    There are no active students currently enrolled in this class to mark attendance for on the selected date.
    Please enroll students via the admin panel or ensure they are active.
</div>
{% endif %}

{% endblock %}
